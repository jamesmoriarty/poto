<!DOCTYPE html>
<html>
<body>
  <input type="text" class="poto-prefix" placeholder="filter by prefix...">
  <section class=poto>

  </section>

  <style>
    body {
      margin:           0;
      background-color: #111;
    }

    .poto-prefix {
      width:       100%;
      line-height: 3em;
      font-size:   2.5em;
    }

    .poto {
      line-height: 0;
    }

    .poto a {
      display:     inline-block;
      width:       25%;
      padding-top: 25%;
      overflow:    hidden;
      outline:     1px;

      background-position: 50% 50%;
      background-repeat:   no-repeat;
    }
  </style>

  <script>
    function poto(container, page) {
      if (this.request) {
        this.request.abort();
      }

      this.request = new XMLHttpRequest();

      request.open("GET", page, true);

      request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
          var json  = JSON.parse(request.response)
          page      = json._links.next.href;

          json._embedded.files.forEach(function(file, i) {
            var link                   = document.createElement("a");
            link.href                  = file._links.file.href;
            link.target                = "_blank"
            link.style.backgroundImage = "url(/ajax-loader.gif)";

            image = new Image();
            image.onload = function() {
              link.style.backgroundImage = "url(" + this.src + ")";
            };
            image.onerror = function() {
              link.parentNode.removeChild(link);
            };
            image.src = "/image_proxy?width=500&height=500&src=" + encodeURIComponent(link.href)

            container.appendChild(link);
          });

          window.onscroll = function(event) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - window.innerHeight * 0.25) {
              window.onscroll = null;
              poto(container, page);
            }
          };
        } else {
          // request error
        }
      };

      request.onerror = function() {
        // connection error
      };

      request.send();
    }

    // main
    var container = document.querySelector('.poto');

    // filter
    document.querySelector('.poto-prefix').onkeyup = function() {
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      poto(container, "/api/files?prefix=" + this.value);
    }

    // default
    poto(container, "/api/files");
  </script>
</body>
</html>
