<!DOCTYPE html>
<html>
<body>
  <input type="text" class="poto-prefix" placeholder="filter by prefix...">
  <section class="poto row-4 clearfix"></section>
  <style>
  /* resets */
  *,
  *:before,
  *:after {
    box-sizing: border-box;
  }
  .clearfix:after {
    content: "";
    display: table;
    clear: both;
  }

  /* input */
  .poto-prefix {
    width:       100%;
    line-height: 3em;
    font-size:   2.5em;
  }

  .poto a {
    height:              500px;
    background-position: 50% 50%;
    background-repeat:   no-repeat;
  }

  /* grid */
  .row {
    margin: 0 -10px;
    margin-bottom: 20px;
  }
  .row:last-child {
    margin-bottom: 0;
  }
  [class*="col-"] {
    padding: 10px;
  }
  @media all and ( min-width: 600px ) {
    .col-2-3 {
      float: left;
      width: 66.66%;
    }
    .col-1-2 {
      float: left;
      width: 50%;
    }
    .col-1-3 {
      float: left;
      width: 33.33%;
    }
    .col-1-4 {
      float: left;
      width: 25%;
    }
    .col-1-8 {
      float: left;
      width: 12.5%;
    }
  }
  </style>

  <script>
    function poto(container, page) {
      if (this.request) {
        this.request.abort();
      }

      this.request = new XMLHttpRequest();

      request.open("GET", page, true);

      request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
          var json  = JSON.parse(request.response)
          page      = json._links.next.href;

          json._embedded.files.forEach(function(file, i) {
            var link                   = document.createElement("a");
            link.href                  = file._links.file.href;
            link.target                = "_blank";
            link.style.backgroundImage = "url(/ajax-loader.gif)";
            link.className             = "col-1-4";

            image = new Image();
            image.onload = function() {
              link.style.backgroundImage = "url(" + this.src + ")";
              link.style.height          = this.height + "px";
            };
            image.onerror = function() {
              link.parentNode.removeChild(link);
            };
            image.src = "/image_proxy?width=500&height=500&src=" + encodeURIComponent(link.href)

            container.appendChild(link);
          });

          window.onscroll = function(event) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - window.innerHeight * 0.25) {
              window.onscroll = null;
              poto(container, page);
            }
          };
        } else {
          // request error
        }
      };

      request.onerror = function() {
        // connection error
      };

      request.send();
    }

    // main
    var container = document.querySelector('.poto');

    // filter
    document.querySelector('.poto-prefix').onkeyup = function() {
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      poto(container, "/api/files?prefix=" + this.value);
    }

    // default
    poto(container, "/api/files");
  </script>
</body>
</html>
