<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
    <title>Poto</title>
    <style>
      .imageList .image {
        margin: 5px;
        border: 1px solid #ccc;
        float: left;
        width: 180px;
      }

      .imageList .image:hover {
        border: 1px solid #777;
      }

      .imageList .image img {
        width: 100%;
        height: auto;
      }

      .imageList .image .desc {
        padding: 15px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="container" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/2.10.0/bluebird.js"></script>
    <script type="text/jsx">
      var ImageGallery = React.createClass({
        getInitialState: function() {
          return { images: this.props.images, next_href: this.props.next_href, disabled: "" };
        },

        getAsync: function(url){
          var xhr = new XMLHttpRequest;
          return new Promise(function (resolve, reject) {
              xhr.addEventListener("error", reject);
              xhr.addEventListener("load", resolve);
              xhr.open("GET", url);
              xhr.send(null);
          }).cancellable().catch(Promise.CancellationError, function(e) {
              xhr.abort();
              throw e; //Don't swallow it
          });
        },

        handleClick: function(event) {
          this.setState({ disabled: "disabled" });

          this.getAsync(this.state.next_href).bind(this).then(
            function(result) {
              json          = JSON.parse(result.target.response);
              var next_href = json._links.next.href;
              var images    = this.state.images.concat(json._embedded.files.map(function(file) {
                var src  = "/image_proxy?width=500&height=500&src=" + encodeURIComponent(file._links.file.href);
                return { src: src };
              }));
              this.setState({ images: images, next_href: next_href, disabled: "" });
            }, function(err) {
              this.setState({ disabled: "" })
            }
          );
        },

        render: function() {
          return (
            <div>
              <ImageList images={this.state.images}/>
              <button disabled={this.state.disabled} next_href={this.state.next_href} onClick={this.handleClick}>Load Images</button>
            </div>
          );
        }
      });

      var ImageList = React.createClass({
        render: function() {
          var imageNodes = this.props.images.map(function (image) {
            return (
              <div class=image>
                <img key={image.src} src={image.src} />
                <div class=desc>{image.src}</div>
              </div
            );
          });
          return (
            <div className="imageList">
              {imageNodes}
            </div>
          );
        }
      });

      React.render(
        <ImageGallery images={[]} next_href={"/api/files?per_page=9"} />,
        document.getElementById('container')
      );
    </script>
  </body>
</html>
